  name: Push the Docker image to AWS ECR Repo
  on:
    push:
      branches:
        - master
        
  jobs:
    Build:
      permissions:
        pull-requests: write

      name: Build
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v4
        
        - name: Run Trivy vulnerability scanner in repo mode
          uses: aquasecurity/trivy-action@0.24.0
          with:
            scan-type: 'fs'
            ignore-unfixed: true
            format: 'sarif'
            output: 'trivy-results.sarif'
            severity: 'CRITICAL'
        
        - name: Upload Trivy scan results to GitHub Security tab
          uses: github/codeql-action/upload-sarif@v2
          with:
            sarif_file: 'trivy-results.sarif'

        - name: Get commit hash
          id: get-commit-hash
          run: echo "commit-hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

        - name: Get timestamp
          id: get-timestamp
          run:  echo "timestamp=$(date +'%Y-%m-%d-%H-%M')" >> $GITHUB_OUTPUT

        - name: Build, tag, and push the image to Amazon ECR
          id: build-image
          env:
            IMAGE_TAG: ${{ steps.get-commit-hash.outputs.commit-hash }}-${{ steps.get-timestamp.outputs.timestamp }}
          run: |
            docker build -t nextapp:$IMAGE_TAG .

        - name: Run Trivy vulnerability scanner
          uses: aquasecurity/trivy-action@0.24.0
          env:
            IMAGE_TAG: ${{ steps.get-commit-hash.outputs.commit-hash }}-${{ steps.get-timestamp.outputs.timestamp }}
          with:
            image-ref: 'nextapp:$IMAGE_TAG'
            format: 'table'
            exit-code: '1'
            ignore-unfixed: true
            vuln-type: 'os,library'
            severity: 'CRITICAL,HIGH'


        - uses: actions/github-script@v7
          if: github.event_name == 'pull_request'
          with:
            script: |
              const output = `

              *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`

              *Workflow: \`${{ github.workflow }}\`, Action: \`${{ github.event.action }}\`

              *[View Run Details]( \`${{ github.event.pull_request.html_url }}/checks)\`
              `;

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: output
              })



          